<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>HDHomeRun DVR</title>
</head>

<body>
    <div class="page pluginConfigurationPage type-interior" data-require="emby-button" data-role="page"
        id="HdhrDvrConfigPage">
        <div data-role="content">
            <div class="content-primary">
                <h1>HDHomeRun DVR</h1>
                <form id="HdhrDvrConfigForm">
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="HdhrDvrMovieRecordingPath">
                            Movie recording path
                        </label>
                        <div style="align-items: center; display: flex;">
                            <div style="flex-grow: 1;">
                                <input id="HdhrDvrMovieRecordingPath" is="emby-input" type="text" />
                            </div>
                            <button class="emby-input-iconbutton" id="HdhrDvrMovieRecordingPathSelect"
                                is="paper-icon-button-light" type="button">
                                <span class="material-icons search"></span>
                            </button>
                        </div>
                        <div class="fieldDescription">Specify the location to save recordings.</div>
                    </div>
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="HdhrDvrSeriesRecordingPath">
                            Series recording path
                        </label>
                        <div style="align-items: center; display: flex;">
                            <div style="flex-grow: 1;">
                                <input id="HdhrDvrSeriesRecordingPath" is="emby-input" type="text" />
                            </div>
                            <button class="emby-input-iconbutton" id="HdhrDvrSeriesRecordingPathSelect"
                                is="paper-icon-button-light" type="button">
                                <span class="material-icons search"></span>
                            </button>
                        </div>
                    </div>
                    <div class="selectContainer">
                        <label class="selectLabel" for="HdhrDvrDeletePolicy">
                            Delete recordings off HDHomeRun tuner...
                        </label>
                        <select class="emby-select emby-select-withcolor" id="HdhrDvrDeletePolicy" is="emby-select"
                            label="Delete recordings off HDHomeRun tuner...">
                            <option value="Never">Never</option>
                            <option value="AfterDeleted">If the recordings are deleted on Jellyfin</option>
                            <option value="AfterOneWeek">One week after successfully downloading to Jellyfin</option>
                            <option value="AfterOneDay">One day after successfully downloading to Jellyfin</option>
                            <option value="AfterDownload">
                                Immediately after successfully downloading to Jellyfin
                            </option>
                        </select>
                        <div class="fieldDescription">
                            Specify when to delete the recordings on the HDHomeRun's storage device after downloading
                            them to Jellyfin.
                        </div>
                        <div class="selectArrowContainer">
                            <span aria-hidden="true" class="keyboard_arrow_down material-icons selectArrow"></span>
                        </div>
                    </div>
                    <div class="selectContainer">
                        <label class="selectLabel" for="HdhrDvrReRecordPolicy">
                            Allow the HDHomeRun tuner to re-record an episode...
                        </label>
                        <select class="emby-select emby-select-withcolor" id="HdhrDvrReRecordPolicy" is="emby-select"
                            label="Allow the HDHomeRun tuner to re-record an episode...">
                            <option value="Always">Always</option>
                            <option value="OnRecordingError">If the existing recording is not full length</option>
                            <option value="IfDeleted">
                                If the recording was deleted on Jellyfin before deleting on the HDHomeRun
                            </option>
                            <option value="Never">Never</option>
                        </select>
                        <div class="fieldDescription">
                            Specify if the HDHomeRun tuner should be allowed to re-record the same episode after the
                            episode is deleted from the HDHomeRun's storage device.
                        </div>
                        <div class="selectArrowContainer">
                            <span aria-hidden="true" class="keyboard_arrow_down material-icons selectArrow"></span>
                        </div>
                    </div>
                    <div>
                        <button class="block emby-button raised" id="HdhrDvrSyncButton" is="emby-button" type="button">
                            <span>Sync Now</span>
                        </button>
                        <progress id="HdhrDvrSyncProgress" min="0" max="100" style="width: 100%;"></progress>
                    </div>
                    <div>
                        <button class="block button-submit emby-button raised" is="emby-button" type="submit">
                            <span>Save</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <script type="text/javascript">
            const pluginId = "EB540661-5435-406D-8A92-F7D8474D247C";
            $(document).on("pageshow", "#HdhrDvrConfigPage", function () {
                Dashboard.showLoadingMsg();
                pluginImport("scripts/taskbutton").then(TaskButton => {
                    TaskButton.default({
                        "button": this.querySelector("#HdhrDvrSyncButton"),
                        "mode": "on",
                        "progressElem": this.querySelector("#HdhrDvrSyncProgress"),
                        "taskKey": "Com.ZachDeibert.MediaTools.Hdhr.Dvr.Jellyfin.SyncTask",
                    });
                });
                ApiClient.getPluginConfiguration(pluginId).then(config => {
                    this.querySelector("#HdhrDvrMovieRecordingPath").value = config.MovieRecordingPath;
                    this.querySelector("#HdhrDvrSeriesRecordingPath").value = config.SeriesRecordingPath;
                    this.querySelector("#HdhrDvrDeletePolicy").value = config.DeletePolicy;
                    this.querySelector("#HdhrDvrReRecordPolicy").value = config.ReRecordPolicy;
                    Dashboard.hideLoadingMsg();
                });
            }).on("submit", "#HdhrDvrConfigForm", function (ev) {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(pluginId).then(config => {
                    config.MovieRecordingPath = this.querySelector("#HdhrDvrMovieRecordingPath").value;
                    config.SeriesRecordingPath = this.querySelector("#HdhrDvrSeriesRecordingPath").value;
                    config.DeletePolicy = this.querySelector("#HdhrDvrDeletePolicy").value;
                    config.ReRecordPolicy = this.querySelector("#HdhrDvrReRecordPolicy").value;
                    ApiClient.updatePluginConfiguration(pluginId, config).then(Dashboard.processPluginConfigurationUpdateResult);
                });
                ev.preventDefault();
                return false;
            }).on("pagehide", "#HdhrDvrConfigPage", function () {
                pluginImport("scripts/taskbutton").then(TaskButton => {
                    TaskButton.default({
                        "button": this.querySelector("#HdhrDvrSyncButton"),
                        "mode": "off",
                        "progressElem": this.querySelector("#HdhrDvrSyncProgress"),
                        "taskKey": "Com.ZachDeibert.MediaTools.Hdhr.Dvr.Jellyfin.SyncTask",
                    });
                });
            });
            ["HdhrDvrMovieRecordingPath", "HdhrDvrSeriesRecordingPath"].forEach(id => {
                $(document).on("click", "#" + id + "Select", () => {
                    pluginImport("components/directorybrowser/directorybrowser").then(DirectoryBrowser => {
                        const picker = new DirectoryBrowser.default();
                        picker.show({
                            "callback": path => {
                                if (path) {
                                    document.querySelector("#" + id).value = path;
                                }
                                picker.close();
                            },
                            "path": document.querySelector("#" + id).value,
                        });
                    });
                });
            });
        </script>
    </div>
</body>

</html>
