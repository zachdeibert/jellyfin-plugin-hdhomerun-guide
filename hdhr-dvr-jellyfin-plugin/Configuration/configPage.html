<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>HDHomeRun DVR</title>
</head>

<body>
    <div class="page pluginConfigurationPage type-interior" data-require="emby-button" data-role="page"
        id="HdhrDvrConfigPage">
        <div data-role="content">
            <div class="content-primary">
                <h1>HDHomeRun DVR</h1>
                <form id="HdhrDvrConfigForm">
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="HdhrDvrMovieRecordingPath">
                            Movie recording path
                        </label>
                        <div style="align-items: center; display: flex;">
                            <div style="flex-grow: 1;">
                                <input id="HdhrDvrMovieRecordingPath" is="emby-input" type="text" />
                            </div>
                            <button class="emby-input-iconbutton" id="HdhrDvrMovieRecordingPathSelect"
                                is="paper-icon-button-light" type="button">
                                <span class="material-icons search"></span>
                            </button>
                        </div>
                        <div class="fieldDescription">
                            Specify the location to save recordings.
                            If left empty, the server's program data folder will be used.
                        </div>
                    </div>
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="HdhrDvrSeriesRecordingPath">
                            Series recording path
                        </label>
                        <div style="align-items: center; display: flex;">
                            <div style="flex-grow: 1;">
                                <input id="HdhrDvrSeriesRecordingPath" is="emby-input" type="text" />
                            </div>
                            <button class="emby-input-iconbutton" id="HdhrDvrSeriesRecordingPathSelect"
                                is="paper-icon-button-light" type="button">
                                <span class="material-icons search"></span>
                            </button>
                        </div>
                    </div>
                    <div>
                        <button class="block emby-button raised" id="HdhrDvrSyncButton" is="emby-button" type="button">
                            <span>Sync Now</span>
                        </button>
                        <progress id="HdhrDvrSyncProgress" min="0" max="100" style="width: 100%;"></progress>
                    </div>
                    <div>
                        <button class="block button-submit emby-button raised" is="emby-button" type="submit">
                            <span>Save</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <script type="text/javascript">
            const pluginId = "EB540661-5435-406D-8A92-F7D8474D247C";
            $(document).on("pageshow", "#HdhrDvrConfigPage", function () {
                Dashboard.showLoadingMsg();
                TaskButton({
                    "button": this.querySelector("#HdhrDvrSyncButton"),
                    "mode": "on",
                    "progressElem": this.querySelector("#HdhrDvrSyncProgress"),
                    "taskKey": "Com.ZachDeibert.MediaTools.Hdhr.Dvr.Jellyfin.SyncTask",
                });
                ApiClient.getPluginConfiguration(pluginId).then(config => {
                    this.querySelector("#HdhrDvrMovieRecordingPath").value = config.MovieRecordingPath;
                    this.querySelector("#HdhrDvrSeriesRecordingPath").value = config.SeriesRecordingPath;
                    Dashboard.hideLoadingMsg();
                });
            }).on("submit", "#HdhrDvrConfigForm", function (ev) {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(pluginId).then(config => {
                    config.MovieRecordingPath = this.querySelector("#HdhrDvrMovieRecordingPath").value;
                    config.SeriesRecordingPath = this.querySelector("#HdhrDvrSeriesRecordingPath").value;
                    ApiClient.updatePluginConfiguration(pluginId, config).then(Dashboard.processPluginConfigurationUpdateResult);
                });
                ev.preventDefault();
                return false;
            }).on("pagehide", "#HdhrDvrConfigPage", function () {
                TaskButton({
                    "button": this.querySelector("#HdhrDvrSyncButton"),
                    "mode": "off",
                    "progressElem": this.querySelector("#HdhrDvrSyncProgress"),
                    "taskKey": "Com.ZachDeibert.MediaTools.Hdhr.Dvr.Jellyfin.SyncTask",
                });
            });
            ["HdhrDvrMovieRecordingPath", "HdhrDvrSeriesRecordingPath"].forEach(id => {
                $(document).on("click", "#" + id + "Select", () => {
                    const picker = new DirectoryBrowser();
                    picker.show({
                        "callback": path => {
                            if (path) {
                                document.querySelector("#" + id).value = path;
                            }
                            picker.close();
                        },
                        "path": document.querySelector("#" + id).value,
                    });
                });
            });
        </script>
    </div>
</body>

</html>
